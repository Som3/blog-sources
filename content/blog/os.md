+++
author = "Vladimir Alekseev"
date = "2018-03-02"
title = "Как мы писали социальную сеть"
category = "programming"
tags = ["programming", "java"]
+++
<p>Прошлым летом ко мне обратился друг, позвал на проект - писать API для социальной сети. Изначально мой грейд не устроил ребят и они нашли парня который должен был выполнить эту, через пару месяцев стало понятно что он ничего не сделает и вновь обратились ко мне. Я согласился на грейд сильно ниже, ибо на тот момент нужны были деньги.</p>
<p> В данном посте я раскажу как мы выстраивали работу, чем пользовались, как просирали сроки и всё это без менеджера. 
<center><img class="post-img" src="/posts/os/index.png"></center>
</p>

`Дальше будет много текса`

<hr/>
<p> Команда у нас был маленькая - я (бэкенд), фронтендер , дизайнер. ТЗ было составлено до моего прихода, да и чего таить - я ни разу не виделся с заказчиками, даже имен не знаю.</p>

Стек мы выбрали тот который хорошо каждый знает, никаких экспериментов. Клиент на `React` , сервер на `java8` с использование `Spring Boot` 

<p> Мокапы были готовы и утверждены, я бегло посмотрел на них и не нашёл никаких проблем, которые всплыли позже (отсутсвие паджинация, одно и тоже поле разных типов на разных страницах и т.д.) - первый блин комом :). После утверждения мокапов - я начал писать API, так как флоу был ясен, фронтендер уже что-то начал делать на клиентской части.</p>

Таск-трекером мы выбрали [Asana](https://asana.com/) - дизайнер и фронтендер давно были с ним знакомы, работали в другой конторе с ним, а мне было всё равно. Но поработав с ним более полугода - я скажу, что он идеально подходит для таких маленьких команд и проектов. Умеет в сабтаски, сроки, выставление исполнителей. Можно создавать саб-проекты, чем мы и пользовались, что бы отделить задачи для каждого человека.
<center><img class="post-img" src="/posts/os/asana.png"></center>
<br/>
Прототипы были сделаны в [Axure](https://www.axure.com/) - думаю в представление не нуждается, давно зарекомендовавшая себя софтина. Да и доступ к нашим прототипам я давно потерял, так что показать ничего не смогу ;)
<br/>
Дизайн хранили в [Invision](https://invisionapp.com/), по сравнению с тем что мы используем на работе ([Creative Cloud](https://www.adobe.com/ru/creativecloud.html)) это просто небо и земля. Я знаю что есть и другие сервисы для этого, но `Creative Cloud` я бы никому не рекомендовал, это лагающее дерьмо мамонта, а инвижн вполне был удобен на нашем проекте.
<center><img class="post-img" src="/posts/os/invision.png"></center>
<center>так выглядит Invision</center>
<br/>
Для хранения кода думали взять приватный репозиторий на [GitHub](https://github.com/), но подумали что это излишки, красивый интерфейс не причина платить и выбрали [BitBucket](https://bitbucket.org/), тем более что доступ к коду нужен был всего 2ум людям.
Работали всего в 2ух ветках, мастер в котором работал клиентщик и api-brunch для меня, время от времени делая мердж.
<p> Я начал писать код в сентябре 2017 года, за месяц реализовал примерно 40% функционала, а вот дизайн всё ещё не был до конца готов. Дизайн рисовался в ночь перед промежуточными показами, ибо дизайнер было перегружен другими заказами - это отразилось на общей производительности и мотивации команды. Когда один неукладывается в сроки, остальные начиют прокрастинировать - очень важно давать жесткие сроки всем своим тиммейтам. </p>
<p> Первый промежуточный показ был пройден, всех всё устроило. Мы начали искать на фрилансе человека который нарисует нам логотип. </p>
<p> Когда дизайн был готов примерно на 50%, фронтенд разработчик начал натягивать верстку на реакт компоненты - где мы опять таки столкнулись с проблемами. Не было единого стайлгайда, кнопки на разных страницах могли отличаться. Дизайнеру была поставлена задача собрать минимальный UI-kit и дальше пользоваться им. </p>
<p> Моя производительность неумолимо падала, проект начинал мне надоедать. Затянувшиеся сроки (проект расчитывался на 3 месяца, но на сегодняшний день он всё ещё не сдан), изначально озвученная маленькая стоимость проекта, впоследствие я понял что и та сумму которую я обозначал в первом раунде переговоров была мала - всё это давало свои плоды. Как итог в декабре я отсилы написал 10-15 строк кода, маленький багфикс и всё.</p>
<p> В январе, после новогодних праздников, я снова приступил к проекту с новыми силами. Производительность вернулся на свой уровень, я быстро закончил оставшуюся часть задач, обернул весь проект в докер контейнеры (client, db, backend), подняли на время тестовый стенд. </p>

Стенд поднимал на [Vscale](https://vscale.io/), взяли самый дешёвый инстанс за 200р месяц (512 RAM, 1 CPU, 20 GB ssd). Админка у этого сервиса вполне приятная, легко добавляют SSH ключи, можно мониторить CPU, трафик, диск. Скрин к сожалению не приложу, в данный момент у меня нету запущенных серверов. На этом этапе я споткнулся об багу Liquibase + Spring Boot ([issue](https://liquibase.jira.com/browse/CORE-2863)). При запуске из джарки он не хотел работать нормально, пришлось выносить запуск в отдельный docker image который ждал поднятия котнейнера с `Postgresql` и запускался на время выполнения скрипта. Дальше у меня начал падать спринг, с малым количеством памяти - крутил, вертел настройки распределения памяти между контейнерами - но 512 МБ не хватало как бы я не пытался.
<br/>
Так же было написано костыльное решение для CI.
```#!/bin/sh

while echo $1 | grep -q ^-; do
    eval $( echo $1 | sed 's/^-//' )=$2
    shift
    shift
done

ROOT=$PWD

# build java
./gradlew clean bootRepackage

# build server docker image
mkdir docker/server/build
cp build/libs/bdsm-1.0-SNAPSHOT.jar docker/server/build/app.jar
cd docker/server
docker build -t ${docker_login}/server:latest . --build-arg SPRING_PROFILE=${profile}
rm -r build

# build client
cd ${ROOT}/src/main/react
npm i
npm run production
```
И примерно тоже самое для деплоя через ssh.

<hr/>
Как-то так, я рассказал что мы использовали для работы, как мы совместно прокрастенировали. На данный момент проект готов процентов на 70, у меня осталось 2 фичи незаимплеменченные, но их отложили на после-релизное время поэтому я не сильно напрягаюсь.
<hr/>

### Уроки вынесенные из этого проекта

- Жесткие сроки внутри команды
- Продумывать прототип до мелочей
- Использовать UI-kit
- Браться за проект ровно за ту сумму, в которую ты его оценил.

### Полезности для меня

- первый проект с нуля
- вспомнил Spring, на основной работе мы его не используем. Но недавно я нашёл подработку как раз на спринге
- потыкал в WebSocket, Docker

<center><img src="/posts/os/dream-team.png"></center>
<center>Наша дрим тим, я справа ;)</center>